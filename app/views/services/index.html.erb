<%# HERO opcional %>
<div class="container-fluid banner d-flex align-items-center justify-content-center text-white">
  <div class="text-center">
    <h1 class="display-3 fw-bold">Encontre o Serviço Perfeito</h1>
    <p class="lead">Conectando você aos melhores profissionais, perto de você.</p>
  </div>
</div>

<%# ===================== BARRA DE BUSCA/FILTROS STICKY ===================== %>
<div class="sticky-search" id="stickySearch">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10 py-3">
        <%= form_with url: services_path(anchor: 'results'),
                      method: :get,
                      class: "mb-0",
                      data: {
                        controller: "location",
                        turbo: false,
                        turbo_action: "advance",
                        location_selected_city_value: params[:city].to_s,
                        location_reset_url_value: services_path(anchor: 'results')
                      } do |form| %>

          <div class="input-group mb-2">
            <%= form.text_field :query,
              class: "form-control form-control-sm",
              placeholder: "Busque por serviço, descrição, nome do profissional ou endereço (rua/bairro/cidade)…",
              value: params[:query] %>
            <button class="btn-search" type="submit">
              <i class="fas fa-search"></i>
            </button>
          </div>

          <div class="row g-2">
            <div class="col-12 col-md-4">
              <%= form.select :category,
                options_for_select([['Todas as Categorias', '']] + Service::CATEGORIES, selected: params[:category]),
                {},
                { class: "form-select form-select-sm", data: { location_target: "category" } } %>
            </div>

            <div class="col-12 col-md-4">
              <%= form.select :state,
                options_for_select([['Todos os Estados', '']] + @states, selected: params[:state]),
                {},
                { data: { location_target: "state" }, class: "form-select form-select-sm" } %>
            </div>

            <div class="col-12 col-md-4">
              <%= form.select :city,
                options_for_select([['Todas as Cidades', '']]),
                {},
                {
                  class: "form-select form-select-sm",
                  data: { location_target: "city" }
                } %>
            </div>
          </div>

          <% if params[:query].present? || params[:category].present? || params[:state].present? || params[:city].present? %>
            <div class="mt-2 mb-0 d-flex gap-2">
              <button type="button"
                      class="btn btn-outline-secondary btn-sm"
                      data-action="click->location#resetFilters">
                Resetar busca
              </button>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<%# ============================== CONTEÚDO =============================== %>
<div class="container main-content">
  <div class="row">
    <%# -------- Coluna ESQUERDA: Lista de serviços -------- %>
    <div class="col-lg-6">
      <h1 class="mb-3 mt-3">Todos os serviços</h1>

      <div id="results"><!-- âncora de destino para pós-busca -->
        <% if @services.empty? %>
          <div class="search-service" role="alert">
            Nenhum serviço encontrado com os filtros aplicados.
          </div>
        <% else %>
          <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
            <% @services.each do |service| %>
              <div class="col">
                <%= link_to service_path(service), class: "text-decoration-none text-dark", data: { turbo: false } do %>
                  <div class="card h-100 border-0">
                    <%# ======= BLOCO DE IMAGEM / CARROSSEL ======= %>

                    <%# 1) Imagem(ens) do SERVIÇO (prioridade máxima) %>
                    <% if service.respond_to?(:images) && service.images.attached? %>
                      <% imgs = service.images.to_a %>
                      <% if imgs.size > 1 %>
                        <div id="service-<%= service.id %>-carousel" class="carousel slide rounded-4 overflow-hidden" data-bs-ride="carousel">
                          <div class="carousel-inner ratio ratio-4x3">
                            <% imgs.each_with_index do |image, i| %>
                              <div class="carousel-item <%= i.zero? ? 'active' : '' %>">
                                <%= image_tag image, class: "d-block w-100 h-100", style: "object-fit: cover;" %>
                              </div>
                            <% end %>
                          </div>
                          <button class="carousel-control-prev" type="button" data-bs-target="#service-<%= service.id %>-carousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Anterior</span>
                          </button>
                          <button class="carousel-control-next" type="button" data-bs-target="#service-<%= service.id %>-carousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Próximo</span>
                          </button>
                        </div>
                      <% else %>
                        <%= image_tag imgs.first, class: "rounded-4", style: "height:200px;width:100%;object-fit:cover;" %>
                      <% end %>

                    <% elsif service.image&.attached? %>
                      <%= image_tag service.image, class: "rounded-4", style: "height:200px;width:100%;object-fit:cover;" %>

                    <%# 2) Banner do PROFISSIONAL (antes das imagens do usuário) %>
                    <% elsif service.user.respond_to?(:banner) && service.user.banner.attached? %>
                      <%= image_tag service.user.banner, class: "rounded-4", style: "height:200px;width:100%;object-fit:cover;" %>

                    <%# 3) Imagem(ens) do PROFISSIONAL (fallback secundário) %>
                    <% elsif service.user.images.attached? %>
                      <% imgs = service.user.images.to_a %>
                      <% if imgs.size > 1 %>
                        <div id="user-<%= service.user.id %>-carousel" class="carousel slide rounded-4 overflow-hidden" data-bs-ride="carousel">
                          <div class="carousel-inner ratio ratio-4x3">
                            <% imgs.each_with_index do |image, i| %>
                              <div class="carousel-item <%= i.zero? ? 'active' : '' %>">
                                <%= image_tag image, class: "d-block w-100 h-100", style: "object-fit: cover;" %>
                              </div>
                            <% end %>
                          </div>
                          <button class="carousel-control-prev" type="button" data-bs-target="#user-<%= service.user.id %>-carousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Anterior</span>
                          </button>
                          <button class="carousel-control-next" type="button" data-bs-target="#user-<%= service.user.id %>-carousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Próximo</span>
                          </button>
                        </div>
                      <% else %>
                        <%= image_tag imgs.first, class: "rounded-4", style: "height:200px;width:100%;object-fit:cover;" %>
                      <% end %>

                    <%# 4) Fallback do pipeline (blindado contra AssetNotFound) %>
                    <% else %>
                      <% fb = Service.fallback_image_for(service.categories) %>
                      <%= begin
                            image_tag fb, class: "rounded-4", style: "height:200px;width:100%;object-fit:cover;"
                          rescue Sprockets::Rails::Helper::AssetNotFound
                            image_tag "servico_reparo_manutencao.png", class: "rounded-4", style: "height:200px;width:100%;object-fit:cover;"
                          end %>
                    <% end %>

                    <%# ======= BODY DO CARD ======= %>
                    <div class="card-body px-0 pt-2">
                      <p class="card-text fw-bold mb-0"><%= service.user.name %></p>
                      <p class="card-text text-muted mb-0 categories"><%= service.categories %></p>
                      <p class="card-text text-muted mb-0 subcategories"><%= service.subcategories %></p>
                      <p class="card-text text-muted mb-0 address">
                        <%= "#{service.user.address}, #{service.user.city}, #{service.user.state}" %>
                      </p>
                      <p class="card-text mt-2 mb-0">
                        <span class="fw-bold"><%= number_to_currency(service.price_hour, unit: "R$") %></span> por hora
                      </p>
                    </div>
                  </div><!-- /card -->
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <%# -------- Coluna DIREITA: Mapa (sticky) -------- %>
    <div class="col-lg-6 d-none d-lg-block">
      <div id="services-map"
          class="map-sticky"
          data-controller="map"
          data-turbo-permanent
          data-turbo="false"
          data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>"
          data-map-markers-value="<%= ERB::Util.json_escape(@markers.to_json) %>"
          data-map-clickable-pins-value="true"
          data-map-spider-radii-value='<%= { 4 => 56, 8 => 84, 12 => 112, "*" => 148 }.to_json %>'>
      </div>
    </div>
  </div>
</div>
