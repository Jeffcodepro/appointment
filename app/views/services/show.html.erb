<!-- app/views/services/show.html.erb -->
<div class="container py-4 service-show">
  <% imgs = @provider.images.to_a %>
  <% category_fallback = {
    "Serviços Domésticos"=>"servico_servicos_domesticos.png",
    "Reparos e Manutenção"=>"servico_reparo_manutencao.png",
    "Saúde e Bem-Estar"=>"servico_saude.png",
    "Aulas e Cursos"=>"servico_consultoria.png",
    "Consultoria"=>"servico_consultoria.png",
    "Eventos"=>"servico_eventos.png",
    "Serviços de Saúde e Estética"=>"servico_saude.png",
    "Serviços Automotivos"=>"servico_reparo_manutencao.png"
  } %>

  <!-- ===== BLOCO SUPERIOR: ESQ (conteúdo) + DIR (mapa) ===== -->
  <div class="row g-4">
    <!-- ESQUERDA: avatar+nome+preço, galeria, ações, descrição -->
    <div class="col-lg-7">

      <!-- HERO: nome do usuário + subcategoria + preço -->
      <div class="d-flex align-items-center gap-3 mb-3">
        <div class="rounded-circle overflow-hidden bg-light" style="width:64px;height:64px;">
          <% if @provider.images.attached? %>
            <%= image_tag imgs.first, class: "w-100 h-100", style: "object-fit: cover;" %>
          <% else %>
            <%= image_tag "avatar_placeholder.png", class: "w-100 h-100", style: "object-fit: cover;" %>
          <% end %>
        </div>

        <div class="flex-grow-1">
          <h1 class="h3 mb-1"><%= @provider.name %></h1>
          <div class="text-muted">
            <%= @service.subcategories.presence || @service.categories %>
            <% if @provider.city.present? || @provider.state.present? %>
              • <%= [@provider.city, @provider.state].compact.join(" - ") %>
            <% end %>
          </div>
        </div>

        <div class="text-end">
          <div class="fs-4 fw-bold"><%= humanized_money_with_symbol(@service.price_hour) %></div>
          <small class="text-muted">por hora</small>
        </div>
      </div>

      <!-- GALERIA -->
      <div class="card border-0 mb-3">
        <div class="card-body p-0">
          <% if imgs.size > 1 %>
            <div id="user-<%= @provider.id %>-carousel" class="carousel slide rounded-4 overflow-hidden" data-bs-ride="carousel">
              <div class="carousel-inner ratio ratio-4x3">
                <% imgs.each_with_index do |image, i| %>
                  <div class="carousel-item <%= i.zero? ? 'active' : '' %>">
                    <%= image_tag image, class: "d-block w-100 h-100", style: "object-fit: cover;" %>
                  </div>
                <% end %>
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#user-<%= @provider.id %>-carousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Anterior</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#user-<%= @provider.id %>-carousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Próximo</span>
              </button>
            </div>
          <% else %>
            <%= image_tag(imgs.first.presence || category_fallback[@service.categories] || "service_reparo_manutencao.png",
                          class: "rounded-4 w-100", style: "height: 360px; object-fit: cover;") %>
          <% end %>
        </div>
      </div>

      <!-- AÇÕES -->
      <div class="d-flex gap-2 mb-3"
          data-controller="schedules"
          data-schedules-service-id-value="<%= @service.id %>">
        <a href="#"
          class="btn btn-schedule-service"
          data-action="click->schedules#open">
          Agendar
        </a>

        <%= link_to "Enviar mensagem", root_path(service_id: @service.id), class: "btn btn-send-a-message" %>

        <%= render "services/schedules_modal" %>
      </div>

      <!-- DESCRIÇÃO -->
      <% if @service.description.present? %>
        <div class="mb-0">
          <h2 class="h5 mb-2">Descrição</h2>
          <div class="text-secondary"><%= simple_format(@service.description) %></div>
        </div>
      <% end %>
    </div>

    <!-- DIREITA: MAPA (sticky) lado a lado até o fim da descrição -->
    <div class="col-lg-5">
      <div class="map-service-show" style="top: calc(var(--nav-h, 56px) + 16px);">
        <div class="card border-0 rounded-4 overflow-hidden shadow-sm">
          <div class="map-fixed" style="min-height: 420px;"
               data-controller="map"
               data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>"
               data-map-markers-value="<%= ERB::Util.json_escape(@markers.to_json) %>">
          </div>
        </div>
        <small class="text-muted d-block mt-2">
          <%= @provider.address %>, <%= @provider.city %> - <%= @provider.state %>
        </small>
      </div>
    </div>
  </div>

  <!-- ===== BLOCO INFERIOR: OUTROS SERVIÇOS ===== -->
  <% if @services_from_provider.any? %>
    <div class="mt-5">
      <h2 class="h5 mb-3">Outros serviços de <%= @provider.name %></h2>

      <div class="vstack gap-3">
        <% @services_from_provider.each do |s| %>
          <%= link_to service_path(s), class: "text-decoration-none text-dark" do %>
            <div class="card border-0 service-tile">
              <div class="card-body d-flex align-items-start justify-content-between">
                <div class="me-3">
                  <div class="fw-semibold"><%= s.subcategories.presence || s.categories %></div>
                  <div class="small text-muted mt-1">
                    <%= s.description.present? ? truncate(s.description, length: 140) : "Descrição breve não informada." %>
                  </div>
                  <div class="mt-2">
                    <span class="badge bg-light text-dark border"><%= s.categories %></span>
                  </div>
                </div>

                <div class="d-flex align-items-center gap-3 ms-auto">
                  <div class="fw-bold mb-0"><%= humanized_money_with_symbol(s.price_hour) %></div>
                  <span class="btn btn-select-service">Selecionar</span>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
<%# teste %>
