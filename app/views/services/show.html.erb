<% content_for :head do %>
  <meta name="turbo-cache-control" content="no-preview">
<% end %>

<%# ===== imagens priorizadas: serviço > banner do profissional > imagens do profissional > fallback ===== %>
<%
  service_imgs =
    if @service.respond_to?(:images) && @service.images.attached?
      @service.images.to_a
    elsif @service.image&.attached?
      [@service.image]
    else
      []
    end

  provider_banner = (@provider.banner if @provider.respond_to?(:banner) && @provider.banner&.attached?)
  provider_imgs   = @provider.images.to_a
%>

<div class="container py-4 service-show">
  <div class="row g-4">
    <!-- ESQUERDA -->
    <div class="col-lg-7">
      <!-- HERO -->
      <div class="d-flex align-items-center gap-3 mb-3">
        <div class="rounded-circle overflow-hidden bg-light" style="width:64px;height:64px;">
          <% if @provider.avatar&.attached? %>
            <%= image_tag @provider.avatar, class: "w-100 h-100", style: "object-fit: cover;" %>
          <% elsif provider_imgs.any? %>
            <%= image_tag provider_imgs.first, class: "w-100 h-100", style: "object-fit: cover;" %>
          <% else %>
            <%= image_tag "avatar_placeholder.png", class: "w-100 h-100", style: "object-fit: cover;" %>
          <% end %>
        </div>

        <div class="flex-grow-1">
          <h1 class="h3 mb-1"><%= @provider.name %></h1>
          <div class="text-muted">
            <%= @service.categories.presence %>
            •
            <%= @service.subcategories.presence || @service.categories %>
            <% if @provider.city.present? || @provider.state.present? %>
              • <%= [@provider.city, @provider.state].compact.join(" - ") %>
            <% end %>
          </div>
        </div>

        <div class="text-end">
          <div class="fs-4 fw-bold"><%= humanized_money_with_symbol(@service.price_hour) %></div>
          <small class="text-muted d-block">por hora</small>
        </div>
      </div>

      <!-- GALERIA -->
      <div class="card border-0 mb-3">
        <div class="card-body p-0">
          <% if service_imgs.size > 1 %>
            <div id="service-<%= @service.id %>-carousel" class="carousel slide rounded-4 overflow-hidden" data-bs-ride="carousel">
              <div class="carousel-inner ratio ratio-4x3">
                <% service_imgs.each_with_index do |image, i| %>
                  <div class="carousel-item <%= i.zero? ? 'active' : '' %>">
                    <%= image_tag image, class: "d-block w-100 h-100", style: "object-fit: cover;" %>
                  </div>
                <% end %>
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#service-<%= @service.id %>-carousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Anterior</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#service-<%= @service.id %>-carousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Próximo</span>
              </button>
            </div>

          <% elsif service_imgs.size == 1 %>
            <%= image_tag service_imgs.first, class: "rounded-4 w-100", style: "height: 360px; object-fit: cover;" %>

          <% elsif provider_banner.present? %>
            <%= image_tag provider_banner, class: "rounded-4 w-100", style: "height: 360px; object-fit: cover;" %>

          <% elsif provider_imgs.size > 1 %>
            <div id="user-<%= @provider.id %>-carousel" class="carousel slide rounded-4 overflow-hidden" data-bs-ride="carousel">
              <div class="carousel-inner ratio ratio-4x3">
                <% provider_imgs.each_with_index do |image, i| %>
                  <div class="carousel-item <%= i.zero? ? 'active' : '' %>">
                    <%= image_tag image, class: "d-block w-100 h-100", style: "object-fit: cover;" %>
                  </div>
                <% end %>
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#user-<%= @provider.id %>-carousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Anterior</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#user-<%= @provider.id %>-carousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Próximo</span>
              </button>
            </div>

          <% else %>
            <% fb = Service.fallback_image_for(@service.categories) %>
            <%= begin
                  image_tag fb, class: "rounded-4 w-100", style: "height: 360px; object-fit: cover;"
                rescue Sprockets::Rails::Helper::AssetNotFound
                  image_tag "servico_reparo_manutencao.png", class: "rounded-4 w-100", style: "height: 360px; object-fit: cover;"
                end %>
          <% end %>
        </div>
      </div>

      <!-- AÇÕES -->
      <div class="d-flex gap-2 mb-3">
        <% if user_signed_in? && current_user.id == @service.user_id %>
          <%= link_to "Ver conversas deste serviço",
                      conversations_path(service_id: @service.id),
                      class: "btn btn--ghost btn-inbox-link" %>

          <button type="button"
                  class="btn btn-cancel-appointment"
                  data-bs-toggle="modal"
                  data-bs-target="#confirmDeleteService-<%= @service.id %>">
            Excluir serviço
          </button>

          <div class="modal fade cancel-modal" id="confirmDeleteService-<%= @service.id %>" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog"><div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Excluir serviço</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body">
                Tem certeza que deseja excluir
                <strong><%= @service.name.presence || "este serviço" %></strong>?
                <div class="small text-muted mt-2">Esta ação não pode ser desfeita.</div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn--ghost" data-bs-dismiss="modal">Cancelar</button>
                <%= button_to "Excluir definitivamente",
                              service_path(@service),
                              method: :delete,
                              form: { data: { turbo_confirm: nil } },
                              class: "btn-cancel-confirm" %>
              </div>
            </div></div>
          </div>
        <% else %>
          <div
            data-controller="schedules"
            data-schedules-service-id-value="<%= @service.id %>"
            data-schedules-logged-in-value="<%= user_signed_in? %>"
            data-schedules-open-hour-value="9"
            data-schedules-close-hour-value="18">
            <button type="button" class="btn-schedule-service" data-action="click->schedules#openClick">
              Agendar
            </button>
            <%= render "services/schedules_modal" %>
          </div>

          <% if user_signed_in? %>
            <%= button_to "Enviar mensagem",
                  conversations_path(service_id: @service.id),
                  method: :post,
                  class: "btn-send-a-message" %>
          <% else %>
            <%= link_to "Enviar mensagem",
                  new_user_session_path(return_to: request.fullpath),
                  class: "btn-send-a-message" %>
          <% end %>
        <% end %>
      </div>

      <!-- CARD DE TEMPO E VALOR ESTIMADO -->
      <% avg = @service.average_hours.to_i %>
      <% if avg.positive? %>
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <div class="small text-muted">Tempo estimado</div>
              <div class="fw-semibold">
                <%= avg %> <%= avg == 1 ? 'hora' : 'horas' %>
              </div>
            </div>

            <div class="vr mx-3 d-none d-md-block"></div>

            <div class="text-end">
              <div class="small text-muted">Valor total estimado</div>
              <div class="fw-bold">
                <%= humanized_money_with_symbol(@service.price_hour * avg) %>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- DESCRIÇÃO -->
      <% if @service.description.present? %>
        <div class="mb-0">
          <h2 class="h5 mb-2">Descrição</h2>
          <div class="text-secondary"><%= simple_format(@service.description) %></div>
        </div>
      <% end %>
    </div>

    <!-- DIREITA: MAPA (sticky) -->
    <div class="col-lg-5">
      <div class="map-shell" style="top: calc(var(--nav-h, 56px) + 16px);">
        <div class="card border-0 rounded-4 overflow-hidden shadow-sm">
          <div class="map-service-show"
               data-controller="map"
               data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>"
               data-map-markers-value="<%= ERB::Util.json_escape(@markers.to_json) %>"
               data-map-clickable-pins-value="false">
          </div>
        </div>
        <small class="text-muted d-block mt-2">
          <%= @provider.address %>, <%= @provider.city %> - <%= @provider.state %>
        </small>
      </div>
    </div>
  </div>

  <!-- ===== OUTROS SERVIÇOS DO MESMO PRO ===== -->
  <% if @services_from_provider.any? %>
    <div class="mt-5">
      <h2 class="h5 mb-3">Outros serviços de <%= @provider.name %></h2>

      <div class="vstack gap-3">
        <% @services_from_provider.each do |s| %>
          <% tile_img = s.display_image %>
          <% dur = s.average_hours.to_i %>

          <%= link_to service_path(s), class: "text-decoration-none text-dark" do %>
            <div class="card border-0 service-tile">
              <div class="card-body">
                <div class="d-grid align-items-center" style="grid-template-columns: 1fr 72px auto; gap: .75rem;">
                  <div class="fw-semibold">
                    <%= s.categories.presence %> • <%= s.subcategories.presence || s.categories %>
                  </div>

                  <div class="d-flex justify-content-center align-items-center">
                    <div class="rounded-circle overflow-hidden" style="width:64px; height:64px; border:1px solid #eee;">
                      <%= begin
                            image_tag tile_img, class: "w-100 h-100", style: "object-fit: cover;"
                          rescue Sprockets::Rails::Helper::AssetNotFound
                            image_tag "servico_reparo_manutencao.png", class: "w-100 h-100", style: "object-fit: cover;"
                          end %>
                    </div>
                  </div>

                  <div class="d-flex justify-content-end align-items-center gap-2 text-nowrap">
                    <div class="fw-bold mb-0"><%= humanized_money_with_symbol(s.price_hour) %></div>
                    <span class="btn btn-select-service">Selecionar</span>
                  </div>
                </div>

                <div class="mt-2">
                  <div class="small text-muted">
                    <%= s.description.present? ? truncate(s.description, length: 140) : "Descrição breve não informada." %>
                  </div>
                  <% if dur.positive? %>
                    <div class="mt-1 small text-muted">
                      duração média: <%= dur %> <%= dur == 1 ? "hora" : "horas" %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
