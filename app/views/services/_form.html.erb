<!-- app/views/services/_form.html.erb -->
<div class="container">
  <h2><%= @service.persisted? ? "Editar serviço" : "Novo serviço" %></h2>

  <%= form_with model: @service,
        data: {
          controller: "service-form",
          "service-form-subcats-value": Service::SUBCATEGORIES.to_json
        } do |f| %>

    <div class="mb-3">
      <%= f.label :name, "Nome do serviço" %>
      <%= f.text_field :name, class: "form-control", required: true %>
    </div>

    <div class="mb-3">
      <%= f.label :categories, "Categoria" %>
      <%= f.select :categories,
                   Service::CATEGORIES,
                   { include_blank: "Selecione uma categoria" },
                   class: "form-select",
                   id: "service_categories",
                   data: {
                     "service-form-target": "category",
                     action: "service-form#onCategoryChange"
                   } %>
    </div>

    <div class="mb-3">
      <%= f.label :subcategories, "Subcategoria" %>
      <%= f.select :subcategories,
                   (@service.categories.present? ? Service::SUBCATEGORIES[@service.categories] : []),
                   { include_blank: "Selecione a subcategoria" },
                   class: "form-select",
                   id: "service_subcategories",
                   data: {
                     selected: @service.subcategories.to_s,
                     "service-form-target": "subcategory"
                   } %>
      <small class="form-text text-muted">Opcional: subcategoria principal exibida na página do serviço.</small>
    </div>

    <div class="mb-3">
      <%= f.label :description, "Descrição" %>
      <%= f.text_area :description, class: "form-control", rows: 3 %>
    </div>

    <div class="row g-3">
      <div class="col-md-4">
        <%= f.label :price_hour, "Preço por hora", class: "form-label" %>
        <%= f.text_field :price_hour,
              class: "form-control",
              placeholder: "Ex.: 150,00",
              id: "service_price_hour",
              data: {
                "service-form-target": "price",
                action: "input->service-form#recalc"
              } %>
      </div>

      <div class="col-md-4">
        <%= f.label :average_hours, "Duração (horas)", class: "form-label" %>
        <%= f.number_field :average_hours,
              class: "form-control",
              step: 1, min: 1,
              id: "service_average_hours",
              data: {
                "service-form-target": "hours",
                action: "input->service-form#recalc"
              } %>
      </div>

      <div class="col-md-4">
        <label class="form-label">Valor total estimado</label>
        <div class="form-control-plaintext fw-semibold"
             id="service_total_preview"
             data-service-form-target="total">R$ 0,00</div>
        <small class="text-muted">Calculado: preço/h × duração</small>
      </div>
    </div>

    <div class="mt-4 d-flex flex-wrap gap-2">
      <%= f.submit (@service.persisted? ? "Atualizar serviço" : "Criar serviço"),
                   class: "btn-create-service" %>

      <%= button_tag "Salvar e criar outro",
            name: "save_and_new", value: "1", type: "submit",
            class: "btn-chat" %>

      <%= link_to "Cancelar",
                  (@service.persisted? ? service_path(@service) : services_path),
                  class: "btn-cancel-service" %>
    </div>
  <% end %>
</div>
