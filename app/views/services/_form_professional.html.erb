<%# app/views/services/_form_professional.html.erb %>

<% if params[:last_service_id].present? %>
  <div class="alert alert-info py-2 mb-3">
    Agora selecione um <strong>Tipo de serviço</strong>, informe o <strong>Preço por hora</strong> e a <strong>Duração</strong>,
    depois clique em <em>Salvar e adicionar outro</em> até concluir sua lista.
  </div>
<% end %>

<%= simple_form_for service, url: services_path,
      html: {
        data: {
          controller: "service-category",
          service_category_subcategories_value: Service::SUBCATEGORIES.to_json
        }
      } do |f| %>

  <%= f.error_notification %>

  <div class="row">
    <div class="col-md-8">
      <%= f.input :name, label: "Nome do serviço",
            input_html: { placeholder: "Ex.: Corte feminino + escova" } %>
    </div>
    <div class="col-md-4">
      <%= f.input :price_hour, label: "Preço por hora (R$)",
            input_html: {
              step: "0.01", inputmode: "decimal",
              data: { service_category_target: "price", action: "input->service-category#recalc" }
            } %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <%= f.input :categories, as: :select, label: "Categoria do serviço",
            collection: Service::CATEGORIES,
            include_blank: "Selecione uma categoria",
            input_html: {
              data: {
                service_category_target: "category",
                action: "change->service-category#categoryChanged"
              }
            } %>
    </div>
    <div class="col-md-6">
      <%= f.input :subcategories, as: :select, label: "Tipo de serviço",
            collection: (Service::SUBCATEGORIES[service.categories] || []),
            include_blank: (service.categories.present? ? "Selecione um tipo de serviço" : "Selecione uma categoria primeiro"),
            input_html: {
              disabled: service.categories.blank?,
              data: { service_category_target: "subcategory" }
            } %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <%= f.input :average_hours, as: :integer, label: "Duração média (horas)",
            input_html: {
              min: 1, max: 12, step: 1,
              data: { service_category_target: "avg", action: "input->service-category#recalc" }
            } %>
    </div>

    <div class="col-md-6 d-flex align-items-end">
      <div class="p-3 rounded-4 border bg-light w-100">
        <div class="small text-muted">Valor total estimado</div>
        <div class="fs-5 fw-bold" data-service-category-target="previewTotal">R$ 0,00</div>
        <div class="small text-muted">Preço/hora × duração</div>
      </div>
    </div>
  </div>

  <%= f.input :description, as: :text, label: "Descrição",
        input_html: { rows: 5, placeholder: "Explique o que está incluso, diferenciais etc." } %>

  <div class="mt-3 d-flex gap-2">
    <%= f.button :submit, "Salvar", class: "btn btn-create-service" %>

    <%= button_tag "Salvar e adicionar outro",
          type: "submit",
          name: "save_and_new",
          value: "1",
          class: "btn btn-outline-secondary" %>

    <%= link_to "Cancelar", dashboard_path, class: "btn btn-cancel-service ms-auto" %>
  </div>
<% end %>

<script>
  // Se estiver voltando de um "Salvar e adicionar outro", foca o campo "Tipo"
  document.addEventListener("turbo:load", () => {
    if (new URLSearchParams(window.location.search).get("last_service_id")) {
      const sub = document.querySelector('[data-service-category-target="subcategory"]');
      if (sub) sub.focus();
    }
  });
</script>
