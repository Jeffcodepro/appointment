<section class="container pt-3">
  <h2>Complete seu perfil profissional</h2>

  <div class="card text-bg-dark banner-card mb-4" id="profile-preview">
    <%# ===== Banner (mostra imagem se houver, senÃ£o placeholder) ===== %>
    <% if @profile.banner.attached? %>
      <%= cl_image_tag @profile.banner.key,
            width: 1600, height: 300, crop: :fill, gravity: :auto,
            fetch_format: :auto, quality: :auto,
            class: "card-img banner-card__img",
            id: "preview-banner-img",
            alt: "Banner de #{@profile.name}" %>
      <div class="card-img banner-card__placeholder d-none" id="preview-banner-placeholder"></div>
    <% else %>
      <img id="preview-banner-img" class="card-img banner-card__img d-none" alt="">
      <div class="card-img banner-card__placeholder" id="preview-banner-placeholder"></div>
    <% end %>

    <div class="card-img-overlay p-3 p-md-4">
      <div class="banner-card__avatar-wrap">
        <%# ===== Avatar PROFISSIONAL (pro_avatar). Sem fallback. ===== %>
        <% if @profile.pro_avatar&.attached? %>
          <%= cl_image_tag @profile.pro_avatar.key,
                width: 120, height: 120, crop: :fill, gravity: :face,
                fetch_format: :auto, quality: :auto,
                class: "rounded-circle shadow banner-card__avatar",
                id: "preview-pro-avatar-img",
                alt: @profile.name %>
          <div id="preview-pro-avatar-fallback" class="rounded-circle d-none banner-card__avatar-fallback"></div>
        <% else %>
          <img id="preview-pro-avatar-img"
               class="rounded-circle shadow banner-card__avatar d-none" alt="">
          <% initials = (@profile.name.presence || @profile.email).split.map { |s| s[0] }.join.first(2).upcase %>
          <div id="preview-pro-avatar-fallback"
               class="rounded-circle d-flex align-items-center justify-content-center banner-card__avatar-fallback shadow">
            <%= initials %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%= simple_form_for @profile,
        url: profile_path(user_id: @profile.id),
        html: { method: :patch, multipart: true, data: { turbo: false } } do |f| %>

    <%= f.error_notification %>

    <%# ===== Input do banner com preview via Stimulus (sem script inline) ===== %>
    <div class="mb-3"
         data-controller="file-input"
         data-file-input-preview-selector-value="#preview-banner-img"
         data-file-input-fallback-selector-value="#preview-banner-placeholder">
      <label>Banner (1920x400 recomendado)</label>
      <%= f.input :banner, as: :file, label: false,
                input_html: { accept: "image/*", data: { file_input_target: "input", action: "change->file-input#change" } } %>
    </div>

    <div class="row">
      <div class="col-md-4"
           data-controller="file-input"
           data-file-input-preview-selector-value="#preview-pro-avatar-img"
           data-file-input-fallback-selector-value="#preview-pro-avatar-fallback">
        <%# ðŸ‘‡ Campo correto para a visÃ£o PROFISSIONAL %>
        <%= f.input :pro_avatar, as: :file, label: "Sua foto (visÃ£o Profissional)",
                  input_html: { accept: "image/*", data: { file_input_target: "input", action: "change->file-input#change" } } %>
      </div>

      <div class="col-md-8">
        <%= f.input :name,        label: "Nome" %>
        <%= f.input :description, label: "DescriÃ§Ã£o", as: :text, input_html: { rows: 4 } %>

        <div class="row">
          <div class="col-md-4">
            <%= f.input :cep,
                        label: "CEP",
                        input_html: { placeholder: "00000-000", autocomplete: "postal-code" } %>
          </div>
          <div class="col-md-8">
            <%= f.input :address,
                        label: "EndereÃ§o (rua/avenida)",
                        hint: "NÃ£o inclua nÃºmero, cidade ou UF aqui.",
                        input_html: { placeholder: "Ex.: PraÃ§a da SÃ©", autocomplete: "address-line1" } %>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4">
            <%= f.input :address_number,
                        label: "NÃºmero",
                        input_html: { placeholder: "Ex.: 252", autocomplete: "address-line2" } %>
          </div>
          <div class="col-md-5">
            <%= f.input :city,
                        label: "Cidade",
                        input_html: { placeholder: "Ex.: SÃ£o Paulo", autocomplete: "address-level2" } %>
          </div>
          <div class="col-md-3">
            <%= f.input :state,
                        label: "UF",
                        as: :select,
                        collection: User::BRAZIL_UF,
                        prompt: "Selecione",
                        input_html: { autocomplete: "address-level1" } %>
          </div>
        </div>

        <%= f.input :phone_number,
                    label: "Telefone",
                    input_html: { placeholder: "(11) 99999-9999", autocomplete: "tel" } %>
      </div>
    </div>

    <div class="mt-3">
      <%= f.button :submit, "Salvar e ir para o dashboard", class: "btn-select-service" %>
    </div>
  <% end %>
</section>
