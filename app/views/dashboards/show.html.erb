
<% content_for :head do %>
  <meta name="turbo-cache-control" content="no-preview">
<% end %>

<div class="dashboard-page">
  <div class="container py-4">

    <!-- Banner com foto do profissional -->
    <div class="card border-0 mb-4 overflow-hidden shadow-sm">
      <div class="row g-0 align-items-center">
        <div class="col-auto p-3">
          <div class="rounded-circle overflow-hidden bg-light" style="width:88px;height:88px;">
            <% if @user.images.attached? %>
              <%= image_tag(@user.images.first, class: "w-100 h-100", style: "object-fit: cover;") %>
            <% else %>
              <%= image_tag("avatar_placeholder.png", class: "w-100 h-100", style: "object-fit: cover;") %>
            <% end %>
          </div>
        </div>
        <div class="col p-3">
          <h1 class="h4 mb-1">Olá, <%= @user.name %></h1>
          <div class="text-muted">Seu painel de agendamentos e receita</div>
        </div>
      </div>
    </div>

    <!-- Corpo (métricas + calendário) dentro de um Turbo Frame -->
    <%= turbo_frame_tag "dashboard-body" do %>
      <%= render partial: "dashboards/body",
                locals: {
                  view: @view, date: @date, prev_date: @prev_date, next_date: @next_date,
                  revenue_human: @revenue_human,
                  revenue_future_human: @revenue_future_human,
                  # contagens
                  count_pending: @count_pending,
                  count_confirmed: @count_confirmed,
                  count_completed: @count_completed,
                  count_canceled_by_client: @count_canceled_by_client,
                  count_canceled_or_rejected_by_professional: @count_canceled_or_rejected_by_professional,
                  # calendário
                  schedules: @schedules, range_start: @range_start, range_end: @range_end
                } %>
    <% end %>

  </div>
</div>

<!-- ===== Modal CSS-only (fora do frame para não ser re-renderizado) ===== -->
<div id="dayEventsModal" class="custom-modal" aria-hidden="true" data-controller="day-modal">
  <div class="custom-modal__overlay" data-action="click->day-modal#close"></div>
  <div class="custom-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="dayEventsLabel">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dayEventsLabel">Agendamentos do dia</h5>
        <button type="button" class="btn-close" aria-label="Fechar" data-action="click->day-modal#close"></button>
      </div>

      <!-- Turbo Frame preenchido ao abrir (Stimulus define o src) -->
      <turbo-frame id="day-events-modal-body">
        <div class="p-4 text-center text-muted">Carregando…</div>
      </turbo-frame>
    </div>
  </div>
</div>
